name: Performance Testing

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:

jobs:
  load-test:
    name: üöÄ Load Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: üß™ Run Load Tests
        run: |
          k6 run --out json=results.json tests/performance/load-test.js
        env:
          API_BASE_URL: https://staging-api.jurisnexo.com

      - name: üìä Generate Report
        run: |
          echo "## üöÄ Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metrics" >> $GITHUB_STEP_SUMMARY
          k6 inspect results.json >> $GITHUB_STEP_SUMMARY

      - name: üì§ Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: results.json

      - name: üö® Alert on Performance Degradation
        run: |
          # Parse results and check thresholds
          p95=$(jq '.metrics.http_req_duration.values.p95' results.json)
          if (( $(echo "$p95 > 500" | bc -l) )); then
            echo "‚ö†Ô∏è P95 latency exceeds 500ms: ${p95}ms"
            exit 1
          fi
