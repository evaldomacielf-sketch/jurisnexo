name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      migration_type:
        description: 'Migration type'
        required: true
        type: choice
        options:
          - update
          - status

jobs:
  migrate:
    name: ðŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: â¬†ï¸ Apply Migrations
        if: github.event.inputs.migration_type == 'update'
        run: |
          pnpm --filter @jurisnexo/db migrate --db-url "${{ secrets[format('{0}_DB_CONNECTION', github.event.inputs.environment)] }}"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ðŸ“Š Migration Status
        if: github.event.inputs.migration_type == 'status'
        run: |
          pnpm --filter @jurisnexo/db migrate:status --db-url "${{ secrets[format('{0}_DB_CONNECTION', github.event.inputs.environment)] }}"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ðŸ“Š Generate Migration Report
        run: |
          echo "## Migration Report" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "Type: ${{ github.event.inputs.migration_type }}" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”” Notify Result
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
