version: '3.8'

# Development override for NestJS API
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # ==========================================
  # NESTJS API (Development)
  # ==========================================
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: jurisnexo-api-dev
    environment:
      - NODE_ENV=development
      - PORT=4000
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/jurisnexo
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - JWT_SECRET=${JWT_SECRET:-super-secret-jwt-key-min-32-chars}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-super-secret-refresh-key-min-32-chars}
      - JWT_EXPIRATION=900
      - JWT_REFRESH_EXPIRATION=604800
      - FRONTEND_URL=http://localhost:3000
    volumes:
      - ./apps/api/src:/app/apps/api/src:ro
      - ./packages:/app/packages:ro
    ports:
      - "4000:4000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - jurisnexo-network
    command: sh -c "pnpm install && pnpm run dev --filter=@jurisnexo/api"
    restart: unless-stopped

  # ==========================================
  # NEXT.JS FRONTEND (Development)
  # ==========================================
  frontend-dev:
    build:
      context: .
      dockerfile: apps/next/Dockerfile
      target: deps
    container_name: jurisnexo-frontend-dev
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:4000/api
      - NEXT_PUBLIC_WS_URL=ws://localhost:4000
    volumes:
      - ./apps/next/src:/app/apps/next/src:ro
      - ./packages:/app/packages:ro
    ports:
      - "3000:3000"
    depends_on:
      - api
    networks:
      - jurisnexo-network
    command: sh -c "pnpm install && pnpm run dev --filter=@jurisnexo/next"
    restart: unless-stopped
